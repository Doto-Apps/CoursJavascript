---
import Layout from "layouts/Layout.astro";
import type { Answers, APIResponse } from "types";
import { Code } from "astro:components";
import { AnswerForm } from "components/AnswerForm.tsx";
import { getQuiz } from "utils/getQuiz";
import { getCookieName } from "utils/getCookieName";
import { getRandomQuestion } from "utils/getRandomQuestion";
import { isNullOrUndefined } from "utils/isNullOrUndefined";

export const prerender = false;

const { quizId, questionNumber: questionNumberString } = Astro.params;

if (!quizId || !questionNumberString) {
  return Astro.redirect("/404");
}

const cookieKey = getCookieName(quizId);
const questionIndex = Number.parseInt(questionNumberString, 10);
const isPost = Astro.request.method === "POST";

const quizData = await getQuiz(quizId, Astro.session);
if (!quizData) {
  return Astro.redirect("/404");
}

if (quizData.mode === "close") {
  return Astro.redirect("closed");
}

const totalQuestions = quizData.questionsPerTest;
const currentQuestion = quizData.questions[questionIndex];

if (!questionNumberString || Number.isNaN(questionIndex) || !currentQuestion) {
  return Astro.redirect("/404");
}

let answers: Answers = {};
if (await Astro.session?.has(cookieKey)) {
  const answersCookie = await Astro.session?.get(cookieKey);
  answers = answersCookie ? (JSON.parse(answersCookie) as Answers) : {};
}

const [_, nextQuestionIndex] = getRandomQuestion(
  quizData.questions,
  Object.keys(answers).map(Number),
);

const meta = {
  title: `MMI Quiz - ${quizData.name}`,
  description: `Testez vos compétences avec ce questionnaire`,
};

const totalAnswers = Object.keys(answers).length;

// ---------- Gestion du temps par question (SERVER-SIDE) ----------

const timeByQuestionInSeconds =
  quizData.mode === "exam" ? quizData.timeByQuestionInSeconds : 0;

// Clé unique pour le deadline de CETTE question
const deadlineKey = `${quizData.uid ?? ""}:deadline:${questionIndex}`;

let deadline = 0;
let remainingSeconds = 0;

if (timeByQuestionInSeconds > 0) {
  const savedDeadline = await Astro.session?.get(deadlineKey);
  const now = Date.now();

  if (savedDeadline) {
    // On réutilise toujours le même deadline => refresh ne reset pas le temps
    deadline = Number(savedDeadline);
  } else {
    // Première fois qu'on arrive sur cette question
    deadline = now + timeByQuestionInSeconds * 1000;
    Astro.session?.set(deadlineKey, String(deadline));
  }

  // Temps restant en secondes, jamais négatif
  remainingSeconds = Math.max(0, Math.floor((deadline - now) / 1000));

  // Si on arrive sur la page alors que le temps est déjà écoulé
  // et que l'étudiant n'a jamais répondu, on marque directement la question comme ratée
  if (remainingSeconds <= 0 && isNullOrUndefined(answers[questionIndex])) {
    answers[questionIndex] = -1;
    Astro.session?.set(cookieKey, JSON.stringify(answers));
  }
}

// ---------- Quand une réponse est soumise (POST) ----------

if (isPost) {
  try {
    const data = await Astro.request.formData();
    const answerIndex = data.get("answerIndex");
    if (typeof answerIndex !== "string") throw new Error("No answer provided");

    // On ne modifie la réponse que si la question n'a jamais été "fixée"
    if (isNullOrUndefined(answers[questionIndex])) {
      let stillInTime = true;

      if (timeByQuestionInSeconds > 0) {
        const savedDeadline = await Astro.session?.get(deadlineKey);
        const now = Date.now();

        if (!savedDeadline) {
          // Pas de deadline enregistré => on refuse par sécurité
          stillInTime = false;
        } else {
          const deadlineFromSession = Number(savedDeadline);
          // Petite marge de 3 secondes comme tu le faisais
          stillInTime = now <= deadlineFromSession + 3000;
        }
      }

      if (timeByQuestionInSeconds > 0 && !stillInTime) {
        // Trop tard => on force la question en -1
        answers[questionIndex] = -1;
        console.log("Réponse refusée (délai dépassé)");
      } else {
        // Réponse dans les temps
        answers[questionIndex] = Number.parseInt(answerIndex, 10);
      }

      Astro.session?.set(cookieKey, JSON.stringify(answers));
    }
  } catch (error) {
    if (error instanceof Error) {
      console.error(error.message);
    }
  }
}

// For malicious student that want the same question
// We already set the cookie in case they change the url for another question it will be count as a false response
if (answers[questionIndex] === null || answers[questionIndex] === undefined) {
  answers[questionIndex] = null;
  Astro.session?.set(cookieKey, JSON.stringify(answers));
}

---

<Layout title={""}>
  {isNullOrUndefined(answers[questionIndex]) &&
  timeByQuestionInSeconds > 0 &&
  remainingSeconds > 0 && (

      <div
        id="quiz-timer"
        class="absolute top-0 left-0 right-0 h-2 bg-primary w-screen z-[1000] quiz-timer-bar"
        data-duration={remainingSeconds}
      ></div>

      <script is:inline>
        (() => {
          const bar = document.getElementById("quiz-timer");
          if (!bar) return;
          const duration = Number(bar.dataset.duration || "0");
          if (!duration || duration <= 0) return;

          // On applique l’animation avec la bonne durée
          bar.style.animation = `quiz-timer ${duration}s linear forwards`;

          bar.addEventListener("animationend", () => {
            const form = document.getElementById("answerForm");
            if (form && typeof form.submit === "function") {
              form.submit();
            }
          });
        })();
      </script>
  )}
  <div class="flex flex-col gap-8">
    <div class="flex flex-col gap-4">
      <div class="text-sm font-semibold">
        <span class="text-white text-xl">
          Question {totalAnswers} sur {totalQuestions}
        </span>{" "}
        du quizz {quizData.name}
      </div>
      <progress
        class="progress progress-primary w-full max-w-lg"
        value={totalAnswers}
        max={totalQuestions}
      ></progress>
    </div>

    <Code code={currentQuestion.question} lang="markdown" />

    <AnswerForm
      hasMoreQuestions={totalAnswers < totalQuestions}
      answerIndex={answers[questionIndex]}
      quizId={quizId}
      answers={currentQuestion.answers}
      question={currentQuestion.question}
      correctAnswerIndex={currentQuestion.correctAnswerIndex}
      nextQuestionIndex={nextQuestionIndex}
      currentLocale={Astro.currentLocale}
    />
  </div>
</Layout>

<style is:global>
  @keyframes quiz-timer {
    from {
      transform: scaleX(1);
    }
    to {
      transform: scaleX(0);
    }
  }

  .quiz-timer-bar {
    transform-origin: left;
  }
</style>