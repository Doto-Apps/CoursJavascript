---
import Layout from "layouts/Layout.astro";
import OpenAI from "openai";
import { z } from "zod";
import { zodResponseFormat } from "openai/helpers/zod";
import { getCookieName } from "utils/getCookieName";
import type { APIResponse } from "types";
import { PATHS } from "paths";
import { v4 as uuidv4 } from "uuid";

export const prefetch = false;

const authKey = btoa(
  `${import.meta.env.LLM_USERNAME}:${import.meta.env.LLM_PASSWORD}`
);
const openai = new OpenAI({
  apiKey: "",
  baseURL: `http://${import.meta.env.LLM_HOSTNAME}/v1`,
  defaultHeaders: {
    Authorization: `Basic ${authKey}`,
  },
});

const quizSchema = z
  .array(
    z.object({
      question: z.string(),
      answers: z.array(z.string().min(1)).length(4),
      correctAnswerIndex: z.number().min(0).max(3),
    })
  )
  .length(10); // Force exactement 10 questions

let quizData: APIResponse = {
  mode: "exam",
  questionsPerTest: 0,
  questions: [],
  timeByQuestionInSeconds: 20,
  name: "Easy Anti Chat GPT",
  uid: uuidv4(),
};

let errorMessage = "";

// ---------------------
// Extraction et réduction du code
// ---------------------

const MAX_LINES_OF_CODE = 150;

type BlockType = "php" | "js" | "css" | "html";

const truncateBlock = (code: string, maxLines: number): string => {
  const lines = code.split(/\r?\n/);
  if (lines.length <= maxLines) return code.trim();
  return lines.slice(0, maxLines).join("\n").trim();
};

function shuffle(array) {
  let currentIndex = array.length;

  // While there remain elements to shuffle...
  while (currentIndex != 0) {

    // Pick a remaining element...
    let randomIndex = Math.floor(Math.random() * currentIndex);
    currentIndex--;

    // And swap it with the current element.
    [array[currentIndex], array[randomIndex]] = [
      array[randomIndex], array[currentIndex]];
  }
}


const extractBlocks = (rawCode: string): Partial<Record<BlockType, string>> => {
  const blocks: Partial<Record<BlockType, string>> = {};

  // PHP
  const phpMatches = Array.from(rawCode.matchAll(/<\?php[\s\S]*?\?>/gi)).map(m => m[0]);
  shuffle(phpMatches)
  if (phpMatches.length > 0) blocks.php = phpMatches.join("\n\n");

  // JS
  const scriptMatches = Array.from(rawCode.matchAll(/<script\b[^>]*>[\s\S]*?<\/script>/gi)).map(m => m[0]);
  shuffle(scriptMatches)
  if (scriptMatches.length > 0) blocks.js = scriptMatches.join("\n\n");

  // CSS
  const cssMatches = Array.from(
    rawCode.matchAll(/(^|\n)\s*(?:[.#][a-zA-Z0-9_-]+|[a-zA-Z][a-zA-Z0-9_-]*)\s*[^{};()\n]*\{[\s\S]*?\}/g)
  ).map(m => m[0]);
  shuffle(cssMatches)
  if (cssMatches.length > 0) blocks.css = cssMatches.join("\n\n");

  // HTML
  const bodyMatch = rawCode.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
  if (bodyMatch && bodyMatch[1].trim().length > 0) {
    blocks.html = bodyMatch[1];
  } else if (/<\s*\w+[^>]*>/.test(rawCode)) {
    blocks.html = rawCode;
  }

  return blocks;
};




const buildTruncatedSnippet = (rawCode: string, maxLines = MAX_LINES_OF_CODE): string => {
  const blocks = extractBlocks(rawCode);
  const orderedTypes: BlockType[] = ["php", "js", "css", "html"];
  const presentTypes = orderedTypes.filter(t => Boolean(blocks[t]));

  if (presentTypes.length === 0) return truncateBlock(rawCode, maxLines);

  const linesPerBlock = Math.max(15, Math.floor(maxLines / presentTypes.length));
  const parts: string[] = [];

  for (const type of presentTypes) {
    const code = blocks[type];
    if (!code) continue;
    parts.push(`/* --- ${type.toUpperCase()} --- */`);
    parts.push(truncateBlock(code, linesPerBlock));
  }

  return truncateBlock(parts.join("\n\n"), maxLines);
};

// ---------------------
// Handler POST
// ---------------------

if (Astro.request.method === "POST") {
  if (await Astro.session?.has(getCookieName("generated"))) {
    Astro.session?.delete(getCookieName("generated"));
  }
  if (await Astro.session?.has("generatedQuiz")) {
    Astro.session?.delete("generatedQuiz");
  }

  try {
    const data = await Astro.request.formData();
    const rawCodeSnippet = data.get("codeSnippet");

    if (!rawCodeSnippet || typeof rawCodeSnippet !== "string") {
      errorMessage = "Code invalide ou manquant.";
    } else {
      const codeSnippet = buildTruncatedSnippet(rawCodeSnippet);

      const systemPrompt = `Tu es un prof qui crée des quiz pour étudiant en web (HTML/CSS/JS/PHP).

Ton job : générer EXACTEMENT 10 questions DIFFÉRENTES sur le code fourni.

RÈGLES SIMPLES :
1. Une question = un concept du code (attribut HTML, propriété CSS, fonction JS, structure PHP)
2. Vocabulaire pour des étudiants
3. Réponses COURTES (10 mots max par réponse)
4. Chaque question doit être DIFFÉRENTE des autres
5. Toujours poser les questions sur les element les plus compliquer du code


EXEMPLES DE BONNES QUESTIONS :
- "Que fait position: absolute ?"
- "À quoi sert l'attribut action ?"
- "Que fait display: flex ?"
- "À quoi sert $_POST ?"
- "Que fait addEventListener ?"

INTERDICTIONS :
- Jamais demander un nom de classe, variable, ID, couleur ou texte du code
- Jamais utiliser de mots compliqués
- Jamais poser 2 fois la même question

FORMAT : Exactement 10 questions en JSON :
[
  {
    "question": "Que fait X ?",
    "answers": ["Réponse courte 1", "Réponse courte 2", "Réponse courte 3", "Réponse courte 4"],
    "correctAnswerIndex": 2
  }
]`;

      const userPrompt = `Code de l'étudiant :
\`\`\`
${codeSnippet}
\`\`\`

Génère 10 questions DIFFÉRENTES sur les concepts utilisés dans CE code.`;

      const response = await openai.chat.completions.parse({
        model: import.meta.env.LLM_MODEL,
        temperature: 0.3,
        top_p: 0.85,
        max_tokens: 6000,
        response_format: zodResponseFormat(quizSchema, "quizSchema"),
        stream: false,
        messages: [
          { role: "system", content: systemPrompt },
          { role: "user", content: userPrompt },
        ],
      });

      quizData.questions =
        (response.choices[0].message.parsed as APIResponse["questions"]) || [];

      if (!quizData || quizData.questions.length === 0) {
        errorMessage = "Erreur : Aucune question générée.";
      } else {
        // Vérification : au moins 10 questions
        if (quizData.questions.length < 10) {
          errorMessage = `Seulement ${quizData.questions.length} questions générées au lieu de 10.`;
        } else {
          // Mélanger aléatoirement les réponses pour chaque question
          quizData.questions = quizData.questions.map(q => {
            const correctAnswer = q.answers[q.correctAnswerIndex];
            
            // Mélanger les réponses
            const shuffled = [...q.answers].sort(() => Math.random() - 0.5);
            
            // Trouver la nouvelle position de la bonne réponse
            const newCorrectIndex = shuffled.indexOf(correctAnswer);
            
            return {
              ...q,
              answers: shuffled,
              correctAnswerIndex: newCorrectIndex
            };
          });

          quizData.questionsPerTest = quizData.questions.length;
          Astro.session?.delete("mmiquiz-generated");
          Astro.session?.set("generatedQuiz", quizData);
          return Astro.redirect(PATHS.quiz("generated"));
        }
      }
    }
  } catch (error) {
    errorMessage = `Erreur API: ${error instanceof Error ? error.message : "Erreur inconnue"}`;
    console.log(errorMessage);
  }
}
---

<Layout title="Générer votre quiz personnalisé !">
  <div class="flex flex-col min-h-screen p-4">
    {errorMessage && (
      <div class="alert alert-error mb-4">
        <span>{errorMessage}</span>
      </div>
    )}
    
    <form method="POST" class="w-full p-6" onsubmit="showLoader()">
      <label for="codeSnippet" class="block font-medium mb-2">
        Collez votre code HTML/CSS/JS/PHP :
      </label>
      <textarea
        name="codeSnippet"
        id="codeSnippet"
        class="w-full p-3 border rounded-lg focus:ring focus:ring-blue-300"
        placeholder="Collez votre code ici..."
        rows="10"
        required
      ></textarea>

      <button
        id="submitButton"
        type="submit"
        class="btn mt-4 w-full btn-primary"
      >
        <span id="loader" class="loading loading-spinner hidden"></span>
        Générer le Quiz (10 questions)
      </button>
    </form>
  </div>

  <script is:inline>
    function showLoader() {
      document.getElementById("submitButton").disabled = true;
      document.getElementById("submitButton").classList.add("cursor-not-allowed");
      document.getElementById("loader").classList.remove("hidden");
    }
  </script>
</Layout>
</document_content>