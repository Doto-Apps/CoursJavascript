---
import Layout from "layouts/Layout.astro";
import OpenAI from "openai";
import { z } from "zod";
import { zodResponseFormat } from "openai/helpers/zod";
import { getCookieName } from "utils/getCookieName";
import type { APIResponse } from "types";
import { PATHS } from "paths";
import { v4 as uuidv4 } from "uuid";

export const prefetch = false;

const authKey = btoa(
  `${import.meta.env.LLM_USERNAME}:${import.meta.env.LLM_PASSWORD}`
);
const openai = new OpenAI({
  apiKey: "",
  baseURL: `http://${import.meta.env.LLM_HOSTNAME}/v1`,
  defaultHeaders: {
    Authorization: `Basic ${authKey}`,
  },
});
console.log("URL", import.meta.env.LLM_HOSTNAME);

// Définition du schéma Zod pour la validation du quiz
const quizSchema = z
  .array(
    z
      .object({
        question: z.string(),
        answers: z
          .array(z.string().min(1, "La réponse ne peut pas être vide"))
          .length(4),
        correctAnswerIndex: z.number().min(0).max(3),
      })
      .required()
  )
  .min(1)
  .max(50);

let quizData: APIResponse = {
  mode: "exam",
  questionsPerTest: 0,
  questions: [],
  timeByQuestionInSeconds: 20,
  name: "Easy Anti Chat GPT",
  uid: uuidv4(),
};

let errorMessage = "";

if (Astro.request.method === "POST") {
  if (await Astro.session?.has(getCookieName("generated"))) {
    Astro.session?.delete(getCookieName("generated"));
  }
  if (await Astro.session?.has("generatedQuiz")) {
    Astro.session?.delete("generatedQuiz");
  }

  try {
    const data = await Astro.request.formData();
    const codeSnippet = data.get("codeSnippet");

    if (!codeSnippet || typeof codeSnippet !== "string") {
      errorMessage = "Code invalide ou manquant.";
    } else {
      // Envoi à OpenAI

      const systemPrompt = `
      Tu es un générateur de quiz pour des étudiants débutants en HTML, CSS et JavaScript.

      Ton rôle :
      - Analyser UNIQUEMENT le code fourni par l'utilisateur.
      - Imaginer le rendu de la page (structure, styles, interactions) à partir de ce code.
      - Générer un quiz qui vérifie la compréhension des concepts réellement utilisés dans ce code.

      Règles GLOBALES (toujours vraies) :

      1. Tu ne parles que d'éléments présents dans le code :
        - balises HTML réellement utilisées,
        - attributs présents,
        - propriétés CSS utilisées,
        - fonctions JavaScript, événements et méthodes réellement présentes.
        Si une balise, une propriété CSS ou une fonction n'apparaît pas dans le code, tu n'en parles pas.

      2. Les questions testent la COMPRÉHENSION, pas la mémoire :
        - OK : "À quoi sert l'attribut \`alt\` dans une balise \`img\` utilisée dans ce code ?"
        - OK : "Dans ce code, à quoi sert la propriété CSS \`display: flex\` appliquée à ce conteneur ?"
        - PAS OK : "Quelle couleur exacte a été utilisée ?" ou "Quel texte exact est affiché dans le titre ?"

      3. Tu te bases sur le rendu de l'étudiant :
        - structure de la page,
        - disposition des éléments,
        - interactions (click, hover, etc.) définies dans le code,
        mais toujours en restant sur les concepts (balises, propriétés, fonctions utilisées), jamais sur des valeurs littérales précises.

      4. Tu génères EXACTEMENT 10 questions à choix multiples.
        - Chaque question a :
          - "question": une chaîne de caractères en français,
          - "answers": un tableau de 4 réponses possibles en français,
          - "correctAnswerIndex": un entier entre 0 et 3.

      5. Tu varies la position de la bonne réponse :
        - Ne mets pas toujours la bonne réponse en position 0.
        - Répartis les \`correctAnswerIndex\` le plus équitablement possible entre 0, 1, 2 et 3.

      6. Les questions doivent être :
        - claires,
        - précises,
        - sans ambiguïté,
        - adaptées à des débutants.

      7. Tu réponds STRICTEMENT au format JSON attendu par le schéma \`quizSchema\` :
        [
          {
            "question": "...",
            "answers": ["...", "...", "...", "..."],
            "correctAnswerIndex": 0
          },
          ...
        ]

      8. Tu ne renvoies AUCUN autre texte en dehors de ce JSON.
      `;
      const userPrompt = `
      Voici le code d'un étudiant.

      Analyse UNIQUEMENT ce code, imagine le rendu de la page, et génère un quiz conformément aux règles données dans le message système.

      Code de l'étudiant :
      \`\`\`html
      ${codeSnippet}
      \`\`\`
      `;

      const response = await openai.chat.completions.parse({
        model: import.meta.env.LLM_MODEL,
        temperature: 0.7,
        top_p: 0.8,
        response_format: zodResponseFormat(quizSchema, "quizSchema"),
        stream: false,
        messages: [
          {
            role: "system",
            content: systemPrompt,
          },
          {
            role: "user",
            content: userPrompt,
          },
        ],
      });

      // Validation de la réponse
      quizData.questions =
        (response.choices[0].message.parsed as APIResponse["questions"]) || [];

      if (!quizData) {
        errorMessage = "Erreur : Aucune donnée valide reçue de OpenAI.";
      } else {
        quizData.questionsPerTest = quizData.questions.length;
        Astro.session?.delete("mmiquiz-generated");
        Astro.session?.set("generatedQuiz", quizData);

        return Astro.redirect(PATHS.quiz("generated"));
      }
    }
  } catch (error) {
    errorMessage = `Erreur API: ${error instanceof Error ? error.message : "Erreur inconnue"}`;
    console.log(errorMessage);
  }
}
---

<Layout title="Générer votre quiz personnalisé !">
  <div class="flex flex-col min-h-screen p-4">
    <form method="POST" class="w-full p-6" onsubmit="showLoader()">
      <label for="codeSnippet" class="block font-medium mb-2"
        >Collez votre code :</label
      >
      <textarea
        name="codeSnippet"
        id="codeSnippet"
        class="w-full p-3 border rounded-lg focus:ring focus:ring-blue-300"
        placeholder="Écrivez votre code ici..."
        rows="10"></textarea>

      <button
        id="submitButton"
        type="submit"
        class="btn mt-4 w-full btn-primary"
      >
        <span id="loader" class="loading loading-spinner hidden"></span>
        Générer votre Quiz
      </button>
    </form>
  </div>

  <script is:inline>
    function showLoader() {
      document.getElementById("submitButton").disabled = true;
      document
        .getElementById("submitButton")
        .classList.add("cursor-not-allowed");
      document.getElementById("loader").classList.remove("hidden");
    }
  </script>
</Layout>
